import time
import subprocess
import select
from pygtail import Pygtail
import smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText


fromaddr = "<%= @notify_from_address %>"
toaddr = "<%= @notify_to_address %>"
msg = MIMEMultipart()
msg['From'] = fromaddr
msg['To'] = toaddr
msg['Subject'] = "<%= @notify_subject %>"

def send_email(person):

  body = "%s has joined the minecraft server!" % person
  msg.attach(MIMEText(body, 'plain'))

  server = smtplib.SMTP('localhost')
  text = msg.as_string()
  server.sendmail(fromaddr, toaddr, text)



for line in Pygtail('<%= @notify_file %>'):
  print line
  if line.find(" joined the game") > -1:
    username = line[line.find(': ')+2:line.find(" joined the game")]
    print "%s has joined the minecraft server" % username
    send_email(username)
